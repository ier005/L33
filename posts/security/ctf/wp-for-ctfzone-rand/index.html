<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Liq3e"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-166034540-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=prev href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-simple-heartbleed/><link rel=next href=https://blog.usec.cc/posts/security/reverse/reverse-basic/><link rel=canonical href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-rand/><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>WP for ctfzone-rand | L33'</title><meta name=title content="WP for ctfzone-rand | L33'"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.usec.cc/"},"articleSection":"posts","name":"WP for ctfzone-rand","headline":"WP for ctfzone-rand","description":"这道题目主要考察伪随机数的安全问题。事实上，在许多web应用中都使用了随机数，但随机数的使用在很多时候并不安全，存在诸如伪随机、种子泄露等问题。 PHP源码分析 题目给出的php源码如下： \u0026lt;?php include(\u0026#39;config.php\u0026#39;); session_set_cookie_params(300); session_start(); echo rand(); if (isset($_GET[\u0026#39;go\u0026#39;])) { $_SESSION[\u0026#39;rand\u0026#39;] = array(); $i = 5; $d = \u0026#39;\u0026#39;; while($i--){ $r = (string)rand(); $_SESSION[\u0026#39;rand\u0026#39;][] = $r; $d .= $r; } echo md5($d); $_SESSION[\u0026#39;secret\u0026#39;] = md5($d); } else if (isset($_GET[\u0026#39;check\u0026#39;])) { if ($_GET[\u0026#39;check\u0026#39;] === $_SESSION[\u0026#39;rand\u0026#39;]) { echo $flag; } else","inLanguage":"zh-Hans","author":"Liq3e","creator":"Liq3e","publisher":"Liq3e","accountablePerson":"Liq3e","copyrightHolder":"Liq3e","copyrightYear":"2017","datePublished":"2017-07-23T00:00:00+08:00","dateModified":"2017-07-23T00:00:00+08:00","url":"https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-rand/","wordCount":1465,"keywords":["ctf","php","pseudo-random","L33'"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.usec.cc/>L33'</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/ title=About>About</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.usec.cc/>L33'</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/ title=About>About</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">WP for ctfzone-rand</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.usec.cc/ rel=author>Liq3e</a> with ♥
<span class=post-time>on <time datetime=2017-07-23 itemprop=datePublished>July 23, 2017</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://blog.usec.cc/categories/security/>Security</a></span></div></header><div class=post-content><p>这道题目主要考察<strong>伪随机数</strong>的安全问题。事实上，在许多web应用中都使用了随机数，但随机数的使用在很多时候并不安全，存在诸如伪随机、种子泄露等问题。</p><h2 id=php源码分析>PHP源码分析</h2><p>题目给出的php源码如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#75715e>&lt;?php</span>
<span style=color:#66d9ef>include</span>(<span style=color:#e6db74>&#39;config.php&#39;</span>);
<span style=color:#a6e22e>session_set_cookie_params</span>(<span style=color:#ae81ff>300</span>);
<span style=color:#a6e22e>session_start</span>();
<span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>rand</span>();
<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;go&#39;</span>])) {
    $_SESSION[<span style=color:#e6db74>&#39;rand&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
    $i <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
    $d <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
    <span style=color:#66d9ef>while</span>($i<span style=color:#f92672>--</span>){
        $r <span style=color:#f92672>=</span> (<span style=color:#a6e22e>string</span>)<span style=color:#a6e22e>rand</span>();
        $_SESSION[<span style=color:#e6db74>&#39;rand&#39;</span>][] <span style=color:#f92672>=</span> $r;
        $d <span style=color:#f92672>.=</span> $r;
    }
    <span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>md5</span>($d);
    $_SESSION[<span style=color:#e6db74>&#39;secret&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>md5</span>($d);
} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;check&#39;</span>])) {
    <span style=color:#66d9ef>if</span> ($_GET[<span style=color:#e6db74>&#39;check&#39;</span>] <span style=color:#f92672>===</span> $_SESSION[<span style=color:#e6db74>&#39;rand&#39;</span>]) {
        <span style=color:#66d9ef>echo</span> $flag;
    } <span style=color:#66d9ef>else</span> {
        <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;die&#39;</span>;
        <span style=color:#a6e22e>session_destroy</span>();
    }
} <span style=color:#66d9ef>else</span> {
    <span style=color:#a6e22e>show_source</span>(<span style=color:#66d9ef>__FILE__</span>);
}

</code></pre></div><p>每次访问页面都会输出一个rand()值。</p><ul><li>当传入了参数<code>go</code>之后，会产生5个随机数，存在Array型变量<code>$_SESSION['rand']</code>中，然后输出五个随机数组成的字符串的md5哈希值</li><li>当传入了参数<code>check</code>之后，会将<code>check</code>的值与<code>$_SESSION['rand']</code>的值进行比较，相等则给出FLAG</li><li>其他情况则给出文件的源码</li></ul><p>无疑，输出的md5哈希值对我们来说没有任何作用，无法通过哈希值来进行逆推。</p><p>题目的思路很明显，通过给出的已产生的随机数，来推导接下来五次产生的随机数。</p><p>此处需要注意的是php的语法问题，最初以为<code>$_SESSION['rand'][] = $r</code>语句的左值全为<code>$_SESSION['rand'][0]</code>，此赋值语句会对同一对象重复赋值。但事实证明，此语句实际上的效果是进行了<strong>append</strong>的操作！
也就是说<code>$_SESSION['rand'][] = $r</code>语句执行五次后，得到了一个有五个元素的数组，元素的值按照之前赋值的顺序依次存储。</p><h2 id=解题历程>解题历程</h2><h3 id=伪随机数的不安全性质>伪随机数的不安全性质</h3><p>有<a href=https://forrestx386.github.io/2017/03/27/%E5%85%B3%E4%BA%8EPHP%E4%B8%AD%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%AE%89%E5%85%A8%E6%80%A7%E5%88%86%E6%9E%90/>文章</a>（同时给出了证明<code>mt_rand()</code>函数不安全的例子）指出，rand()函数来产生随机数，事实上是极其不安全的，可以通过以往产生的随机数来推导出下一个要产生的随机数。</p><p>有如下公式给出了<code>rand()</code>产生随机数的推导公式，此公式的成功率为50%。</p><pre><code>random[i] = random[i-3] + random[i-31]
</code></pre><p>题目给出了每次产生的随机数值，所以可以构造脚本来获取前32个随机数的值，传入<code>go</code>参数后，自己推导后五个随机数的数值，之后将其作为<code>check</code>参数的值，进行提交。由于上述公式成功率不为100%，所以需要进行多次尝试。</p><blockquote><p>rand()函数是可以指定产生的随机数的范围的，在未指定的情况下，默认范围为0~2147483646，所以进行推导时，每次的和应该模<code>2147483647</code>取余。</p></blockquote><h3 id=http参数传入数组>HTTP参数传入数组</h3><p>HTTP是可以通过<code>GET</code>或者<code>POST</code>的请求来传递数组的，两种传递方式其实一样。</p><pre><code>?info[name]=huyongde&amp;info[age]=20
</code></pre><p>通过上面的方式进行参数传递，则在PHP后端<code>$_GET['info']</code>或者<code>$_POST['info']</code> 是一个数组：</p><pre><code>array('name'=&gt;'huyongde', 'age'=&gt;20);
</code></pre><p>其中，参数传递时的中括号内可以为空。</p><h3 id=最终脚本>最终脚本</h3><p>最终python脚本如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python</span>

<span style=color:#f92672>import</span> requests

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>force</span>():
	r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>session()
	url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://.../?&#34;</span>

	rand <span style=color:#f92672>=</span> []
	<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>31</span>):
		content <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>get(url)<span style=color:#f92672>.</span>text
		index <span style=color:#f92672>=</span> content<span style=color:#f92672>.</span>index(<span style=color:#e6db74>&#39;&lt;code&gt;&#39;</span>)
		rand<span style=color:#f92672>.</span>append(int(content[:index]))
<span style=color:#75715e>#		print rand</span>

	content <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>get(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;go=&#39;</span>)<span style=color:#f92672>.</span>text
	rand<span style=color:#f92672>.</span>append(int(content[:<span style=color:#f92672>-</span><span style=color:#ae81ff>32</span>]))

	<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>37</span>):
		rand<span style=color:#f92672>.</span>append((rand[i <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>] <span style=color:#f92672>+</span> rand[i <span style=color:#f92672>-</span> <span style=color:#ae81ff>31</span>]) <span style=color:#f92672>%</span> <span style=color:#ae81ff>2147483647</span>)
		url <span style=color:#f92672>+=</span> (<span style=color:#e6db74>&#39;check[]=&#39;</span> <span style=color:#f92672>+</span> str(rand[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]))
		<span style=color:#66d9ef>if</span> i <span style=color:#f92672>!=</span> <span style=color:#ae81ff>36</span>:
			url <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&amp;&#39;</span>

	content <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>get(url)<span style=color:#f92672>.</span>text;
	<span style=color:#66d9ef>print</span> content
	<span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;die&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> content:
		exit(<span style=color:#ae81ff>0</span>)

<span style=color:#66d9ef>while</span> True:
	force()
</code></pre></div><h3 id=获取flag>获取FLAG</h3><p>获得Flag如下：</p><pre><code>0CTF{rand_is_rand?_maybe_not}
</code></pre><p>注意开始的字符0，不要将其当作随机数的个位数。。。</p><h2 id=总结>总结</h2><p>在php中，两种产生随机数的方法都是不安全的。一个是<code>rand()</code>，另一个是<code>mt_rand()</code>，他们都只保证了随机数的均匀性，但具有<strong>可重现</strong>和<strong>可预测</strong>的不安全性质。如果随机数的种子泄露，则使用相同的种子得到的随机数序列是完全相同的，是为可重现性；即使没有随机数的种子，仍然可以通过以往的随机数值，来推导出下一个即将产生的随机数值。</p><ul><li>对于<code>rand()</code>来说，可以通过以往的随机数序列推导出即将要产生的随机数，随机数序列<code>random[i] = random[i-3] + random[i-31]</code>，此公式成功率能达到50%。</li><li>对于<code>mt_rand()</code>来说，则可以通过产生的一个随机数进行推导出可能的种子，进而能够得到整个随机序列。有程序<a href=http://download.openwall.net/pub/projects/php_mt_seed/>php_mt_seed</a>实现了此功能。</li></ul></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Liq3e</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-rand/>https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-rand/</a></p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://blog.usec.cc/tags/ctf/>#ctf</a></span>
<span class=tag><a href=https://blog.usec.cc/tags/php/>#php</a></span>
<span class=tag><a href=https://blog.usec.cc/tags/pseudo-random/>#pseudo-random</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://blog.usec.cc/>home</a></span></section></div><div class=post-nav><a href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-simple-heartbleed/ class=prev rel=prev title="WP for ctfzone-simple-heartbleed"><i class="iconfont icon-left"></i>&nbsp;WP for ctfzone-simple-heartbleed</a>
<a href=https://blog.usec.cc/posts/security/reverse/reverse-basic/ class=next rel=next title=逆向工程基础>逆向工程基础&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"l33-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2020</span>
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://blog.usec.cc/>Liq3e</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/liuzc/leaveit target=_blank rel="external nofollow">LeaveIt</a></span></div></footer><script src=/js/vendor_no_gallery.min.js async></script></div></body></html>