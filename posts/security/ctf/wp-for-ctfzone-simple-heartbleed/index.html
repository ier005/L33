<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Liq3e"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-166034540-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=next href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-rand/><link rel=canonical href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-simple-heartbleed/><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>WP for ctfzone-simple-heartbleed | L33'</title><meta name=title content="WP for ctfzone-simple-heartbleed | L33'"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.usec.cc/"},"articleSection":"posts","name":"WP for ctfzone-simple-heartbleed","headline":"WP for ctfzone-simple-heartbleed","description":"这道题目实际上是一道hticon的题目，原本题目的名称叫做leaking，而ctfzone改名叫做simple haertbleed，这也是有原因的，因为这道题目跟OpenSSL的著名漏洞Heartbleed有相似之处，是利用了缓冲区溢出的漏洞。 题目分析 题目直接给出了WEB服务器后","inLanguage":"zh-Hans","author":"Liq3e","creator":"Liq3e","publisher":"Liq3e","accountablePerson":"Liq3e","copyrightHolder":"Liq3e","copyrightYear":"2017","datePublished":"2017-07-23T00:00:00+08:00","dateModified":"2017-07-23T00:00:00+08:00","url":"https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-simple-heartbleed/","wordCount":947,"keywords":["ctf","buffer overflow","L33'"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.usec.cc/>L33'</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/ title=About>About</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.usec.cc/>L33'</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>Posts</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/ title=About>About</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">WP for ctfzone-simple-heartbleed</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.usec.cc/ rel=author>Liq3e</a> with ♥
<span class=post-time>on <time datetime=2017-07-23 itemprop=datePublished>July 23, 2017</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://blog.usec.cc/categories/security/>Security</a></span></div></header><div class=post-content><p>这道题目实际上是一道hticon的题目，原本题目的名称叫做<strong>leaking</strong>，而ctfzone改名叫做<strong>simple haertbleed</strong>，这也是有原因的，因为这道题目跟OpenSSL的著名漏洞<a href=http://heartbleed.com/>Heartbleed</a>有相似之处，是利用了<strong>缓冲区溢出</strong>的漏洞。</p><h2 id=题目分析>题目分析</h2><p>题目直接给出了WEB服务器后端的源码，如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#e6db74>&#34;use strict&#34;</span>;

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>randomstring</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;randomstring&#34;</span>);
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
<span style=color:#66d9ef>var</span> {<span style=color:#a6e22e>VM</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;vm2&#34;</span>);
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>flag</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./config.js&#34;</span>).<span style=color:#a6e22e>flag</span>

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>);

    <span style=color:#75715e>/*    Orange is so kind so he put the flag here. But if you can guess correctly :P    */</span>
    eval(<span style=color:#e6db74>&#34;var flag_&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>randomstring</span>.<span style=color:#a6e22e>generate</span>(<span style=color:#ae81ff>64</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; = \&#34;flag{&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>flag</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;}\&#34;;&#34;</span>)
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12</span>) {
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>vm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>VM</span>({
            <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1000</span>
        });
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>);
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;eval -&gt;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>));
    } <span style=color:#66d9ef>else</span> {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#a6e22e>__filename</span>).<span style=color:#a6e22e>toString</span>());
    }
});

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>80</span>, <span style=color:#66d9ef>function</span> () {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;listening on port 80!&#34;</span>);
});
</code></pre></div><p>这才知道原来<strong>JavaScript</strong>还可以用作服务器的后端语言，这道题目的后台使用了Node.js的WEB框架<a href=http://expressjs.com/>Express</a>，并且在题目中使用了运行不受信任代码代码的沙盒<a href=https://github.com/patriksimek/vm2>VM2</a>。</p><p>看过源码之后，很容易就能看出，可以通过<code>data</code>参数使用<code>GET</code>方法来上传代码执行，目的是获取FLAG。但题目中给出了两个限制：</p><ul><li>上传代码长度限制为12</li><li>在沙盒VM2中能够执行的语句相当有限，需要绕过VM2的限制获取FLAG</li></ul><h2 id=解题过程>解题过程</h2><h3 id=绕过参数长度限制>绕过参数长度限制</h3><p>代码对<code>data</code>参数进行了长度限制，不能超过12个字符。这可以通过传递数组参数来进行绕过（在这一点上似乎跟PHP有些不同，PHP的数组元素转换为字符串的时候，会得到<code>'Array'</code>的转换结果），这样判断的就不是字符串的长度，而是数组的长度，如下：</p><pre><code>?data[]=code.....
</code></pre><h3 id=绕过沙盒限制>绕过沙盒限制</h3><p>关于如何绕过沙盒的限制来获取FLAG，题目名称已经给出了提示。从题目源码中，看起来貌似正确的解题思路是破解<code>falg_randomstring.generate(64)</code>这一随机变量名，但实际上这只是一种误导而已。</p><p>纵然VM2的目的是提供了安全的沙盒环境，但可以在github上可以看到<a href=https://github.com/patriksimek/vm2/issues/32>ISSUE</a>提到了绕过方式，但这些方法不能用到这一题目上。从题目的<strong>Simple Heartbleed</strong>可以得到提示，这是一个著名的OpenSSL的缓冲区溢出的漏洞，而Node.js是否也存在这种漏洞呢？答案是肯定的。</p><p>我们可以通过Node.js这一<a href=https://github.com/nodejs/node/issues/4660>缓冲区溢出</a>漏洞来获取内存中的数据，在获取的二进制数据中，搜索我们想要的FLAG。</p><p>构造如下GET请求：</p><pre><code>http://...?data=new%20Buffer(10000)
</code></pre><p>会跳出一个下载，拿到10000字节的数据，通过strings命令，可以找到其中的字符串，其中就有FLAG：</p><pre><code>flag{h34rtbleed?}
</code></pre></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Liq3e</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-simple-heartbleed/>https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-simple-heartbleed/</a></p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://blog.usec.cc/tags/ctf/>#ctf</a></span>
<span class=tag><a href=https://blog.usec.cc/tags/buffer-overflow/>#buffer overflow</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://blog.usec.cc/>home</a></span></section></div><div class=post-nav><a href=https://blog.usec.cc/posts/security/ctf/wp-for-ctfzone-rand/ class=next rel=next title="WP for ctfzone-rand">WP for ctfzone-rand&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"l33-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2020</span>
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://blog.usec.cc/>Liq3e</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/liuzc/leaveit target=_blank rel="external nofollow">LeaveIt</a></span></div></footer><script src=/js/vendor_no_gallery.min.js async></script></div></body></html>